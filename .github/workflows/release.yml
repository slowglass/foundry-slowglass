name: Release Module

on: 
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get module metadata
        id: module_metadata
        run: |
          ID=$(jq -r '.id' module.json)
          VERSION=$(jq -r '.version' module.json)
          echo "module_id=$ID" >> $GITHUB_OUTPUT
          echo "module_version=$VERSION" >> $GITHUB_OUTPUT

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Foundry CLI
        run: npm install -g @foundryvtt/foundryvtt-cli

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python Dependencies
        run: pip install Pillow

      - name: Build Module
        run: ./scripts/build.sh

      - name: Create module zip
        run: |
          zip -r module.zip . \
            -x ".git/*" \
            -x "*.zip" \
            -x "build.ps1" \
            -x ".github/*" \
            -x ".build/*"

      - name: List files for debugging
        run: ls -la

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./module.json
            ./module.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

