{
  "name": "Macro Request Skill",
  "type": "script",
  "author": "slowglass",
  "img": "modules/foundry-slowglass/icons/macros/macro-request-skill.png",
  "scope": "global",
  "command": "/**\n * Macro: Request Skill Checks (foundry-slowglass)\n * Presents a fully icon-based dialog to request Skill Checks.\n */\n\n(async () => {\n    const MODULE_NAME = \"foundry-slowglass\";\n    const ASSET_PATH = \"modules/foundry-slowglass/assets/icons\";\n    const DEFAULT_ICON = \"icons/dice/d20black.svg\";\n\n    // 1. Icon Configuration Arrays\n    const SKILL_ICONS = {\n        acr: `${ASSET_PATH}/skill/acrobatics.svg`,\n        ani: `${ASSET_PATH}/skill/animal-handling.svg`,\n        arc: `${ASSET_PATH}/skill/arcana.svg`,\n        ath: `${ASSET_PATH}/skill/athletics.svg`,\n        dec: `${ASSET_PATH}/skill/deception.svg`,\n        his: `${ASSET_PATH}/skill/history.svg`,\n        ins: `${ASSET_PATH}/skill/insight.svg`,\n        itm: `${ASSET_PATH}/skill/intimidation.svg`,\n        inv: `${ASSET_PATH}/skill/investigation.svg`,\n        med: `${ASSET_PATH}/skill/medicine.svg`,\n        nat: `${ASSET_PATH}/skill/nature.svg`,\n        prc: `${ASSET_PATH}/skill/perception.svg`,\n        prf: `${ASSET_PATH}/skill/performance.svg`,\n        per: `${ASSET_PATH}/skill/persuasion.svg`,\n        rel: `${ASSET_PATH}/skill/religion.svg`,\n        slt: `${ASSET_PATH}/skill/sleight-of-hand.svg`,\n        ste: `${ASSET_PATH}/skill/stealth.svg`,\n        sur: `${ASSET_PATH}/skill/survival.svg`\n    };\n\n    const ADV_ICONS = {\n        advantage: `${ASSET_PATH}/dice/advantage.svg`,\n        normal: `${ASSET_PATH}/dice/d20.svg`,\n        disadvantage: `${ASSET_PATH}/dice/disadvantage.svg`\n    };\n\n    // 2. Gather Data from CONFIG\n    const skills = CONFIG.DND5E.skills;\n\n    // 3. Build Category Data (Icon-based Buttons)\n    const advBtnHtml = Object.entries(ADV_ICONS).map(([mode, icon]) => {\n        const label = mode.charAt(0).toUpperCase() + mode.slice(1);\n        return `<button type=\"button\" class=\"adv-btn ${mode === 'normal' ? 'active' : ''}\" data-adv=\"${mode}\" title=\"${label}\">\n            <img src=\"${icon}\" />\n        </button>`;\n    }).join(\"\");\n\n    const skillBtns = Object.entries(skills)\n        .sort((a, b) => a[1].label.localeCompare(b[1].label))\n        .map(([id, data]) => {\n            const icon = SKILL_ICONS[id] || DEFAULT_ICON;\n            return `<button type=\"button\" class=\"id-btn\" data-id=\"${id}\" title=\"${data.label}\">\n                <img src=\"${icon}\" />\n            </button>`;\n        }).join(\"\");\n\n    // 4. Gather Potential Actors (Player-owned)\n    const actors = game.actors.filter(a => a.hasPlayerOwner);\n    const targetedUuids = Array.from(game.user.targets).map(t => t.actor?.uuid);\n\n    const actorPortraits = actors.map(a => {\n        const imgSrc = a.prototypeToken?.texture?.src || a.img;\n        const isSelected = targetedUuids.includes(a.uuid);\n        return `\n            <div class=\"actor-portrait ${isSelected ? 'active' : ''}\" data-uuid=\"${a.uuid}\" title=\"${a.name}\">\n                <img src=\"${imgSrc}\" />\n            </div>\n        `;\n    }).join(\"\");\n\n    // 5. Build Dialog Content\n    const content = `\n    <style>\n        .roll-request-dialog { overflow: visible; }\n        .roll-request-dialog .section-label { font-weight: bold; display: block; margin-bottom: 8px; border-bottom: 1px solid #7a7971; padding-bottom: 2px; }\n        \n        .roll-request-dialog .btn-grid { \n            display: flex;\n            flex-wrap: wrap;\n            justify-content: center;\n            gap: 0px; \n            margin-bottom: 20px; \n            width: 100%;\n            padding: 0 10px;\n            margin-left: 0;\n            margin-right: 0;\n        }\n        \n        .roll-request-dialog .mode-selection {\n            display: flex;\n            justify-content: center;\n            gap: 0px;\n            width: 100%;\n            margin-bottom: 20px;\n        }\n\n        .roll-request-dialog .mode-divider {\n            width: 1px;\n            height: 100%;\n            background: #7a7971;\n            margin: 0 auto;\n        }\n\n        .roll-request-dialog button {\n            padding: 2px;\n            cursor: pointer;\n            border: 1px solid #7a7971;\n            background: rgba(0,0,0,0.1);\n            width: 64px;\n            height: 64px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n        }\n        .roll-request-dialog button img {\n            width: 100%;\n            height: 100%;\n            object-fit: contain;\n            opacity: 1.0 !important;\n        }\n        .roll-request-dialog button.active {\n            border: 3px solid #ff6400 !important;\n            box-shadow: 0 0 12px #ff6400 !important;\n            background: none !important;\n        }\n        \n        .roll-request-dialog .actor-grid { \n            display: flex;\n            flex-wrap: wrap;\n            justify-content: center;\n            gap: 0px;\n            max-height: 400px; \n            overflow-y: auto; \n            margin-top: 10px;\n            width: 100%;\n            padding: 0 10px;\n            margin-left: 0;\n            margin-right: 0;\n        }\n\n        .roll-request-dialog .actor-portrait {\n            position: relative;\n            cursor: pointer;\n            border: 1px solid #7a7971;\n            width: 96px;\n            height: 96px;\n            overflow: hidden;\n            background: rgba(0,0,0,0.1);\n            transition: all 0.2s ease;\n            box-sizing: border-box;\n        }\n        .roll-request-dialog .actor-portrait img {\n            width: 100%;\n            height: 100%;\n            object-fit: cover;\n            opacity: 1.0 !important;\n        }\n        .roll-request-dialog .actor-portrait.active {\n            border: 3px solid #ff6400 !important;\n            box-shadow: 0 0 12px #ff6400 !important;\n            background: none !important;\n        }\n    </style>\n    \n    <div class=\"roll-request-dialog\">\n        <div class=\"mode-selection\">\n            ${advBtnHtml}\n        </div>\n        <input type=\"hidden\" id=\"roll-type\" value=\"skill\">\n        <input type=\"hidden\" id=\"roll-adv\" value=\"normal\">\n\n        <div id=\"selection-grid\" class=\"btn-grid\">\n            ${skillBtns}\n        </div>\n        <input type=\"hidden\" id=\"roll-id\" value=\"\">\n\n        <div class=\"actor-grid\">\n            ${actorPortraits || \"<em>No player characters found.</em>\"}\n        </div>\n    </div>\n    `;\n\n    // 6. Render Dialog\n    new Dialog({\n        title: \"Request Skill Check\",\n        content: content,\n        buttons: {\n            request: {\n                icon: '<i class=\"fas fa-bullhorn\"></i>',\n                label: \"Request\",\n                callback: (html) => {\n                    const rollType = \"skill\";\n                    const advantageMode = html.find('#roll-adv').val();\n                    const id = html.find('#roll-id').val();\n                    const selectedUuids = html.find('.actor-portrait.active').map((i, el) => $(el).data('uuid')).get();\n\n                    if (!id) {\n                        ui.notifications.warn(\"No Skill selected.\");\n                        return false;\n                    }\n                    if (selectedUuids.length === 0) {\n                        ui.notifications.warn(\"No actors selected.\");\n                        return false;\n                    }\n\n                    game.socket.emit(\"module.\" + MODULE_NAME, {\n                        type: \"requestRoll\",\n                        actorUuids: selectedUuids,\n                        rollType: rollType,\n                        id: id,\n                        advantageMode: advantageMode\n                    });\n\n                    ui.notifications.info(`Requested ${id.toUpperCase()} ${rollType} (${advantageMode}) from ${selectedUuids.length} actor(s).`);\n                }\n            }\n        },\n        default: \"request\",\n        render: (html) => {\n            const advBtns = html.find('.adv-btn');\n            const selectionGrid = html.find('#selection-grid');\n            const rollAdvInput = html.find('#roll-adv');\n            const rollIdInput = html.find('#roll-id');\n            const actorGrid = html.find('.actor-grid');\n\n            // Handle Actor Portrait clicks\n            actorGrid.on('click', '.actor-portrait', (event) => {\n                const portrait = $(event.currentTarget);\n                portrait.toggleClass('active');\n            });\n\n            // Handle ID button clicks\n            selectionGrid.on('click', '.id-btn', (event) => {\n                const btn = $(event.currentTarget);\n                selectionGrid.find('.id-btn').removeClass('active');\n                btn.addClass('active');\n                rollIdInput.val(btn.data('id'));\n            });\n\n            // Handle Advantage Mode switching\n            advBtns.on('click', (event) => {\n                const btn = $(event.currentTarget);\n                advBtns.removeClass('active');\n                btn.addClass('active');\n                rollAdvInput.val(btn.data('adv'));\n            });\n        }\n    }).render(true);\n})();",
  "folder": null,
  "sort": 0,
  "ownership": {
    "default": 0
  },
  "flags": {},
  "_id": "7e777b374aeb8766",
  "_key": "!macros!7e777b374aeb8766",
  "_stats": {
    "systemId": "dnd5e",
    "systemVersion": "4.0.0",
    "coreVersion": "13.350",
    "createdTime": 1768663480870,
    "modifiedTime": 1768663480870,
    "lastModifiedBy": "slowglass"
  }
}