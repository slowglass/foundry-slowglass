{
  "name": "Macro Request Ability",
  "type": "script",
  "author": "slowglass",
  "img": "modules/foundry-slowglass/icons/macros/macro-request-ability.png",
  "scope": "global",
  "command": "/**\n * Macro: Request Ability Checks & Saves (foundry-slowglass)\n * Presents a fully icon-based dialog to request Saving Throws or Ability Checks.\n */\n\n(async () => {\n    const MODULE_NAME = \"foundry-slowglass\";\n    const ASSET_PATH = \"modules/foundry-slowglass/assets/icons\";\n    const DEFAULT_ICON = \"icons/dice/d20black.svg\";\n\n    // 1. Icon Configuration Arrays\n    const MODE_ICONS = {\n        save: `${ASSET_PATH}/attribute/saving-throw.svg`,\n        check: `${ASSET_PATH}/attribute/test.svg`\n    };\n\n    const ABILITY_ICONS = {\n        str: `${ASSET_PATH}/ability/strength.svg`,\n        dex: `${ASSET_PATH}/ability/dexterity.svg`,\n        con: `${ASSET_PATH}/ability/constitution.svg`,\n        int: `${ASSET_PATH}/ability/intelligence.svg`,\n        wis: `${ASSET_PATH}/ability/wisdom.svg`,\n        cha: `${ASSET_PATH}/ability/charisma.svg`\n    };\n\n    const ADV_ICONS = {\n        advantage: `${ASSET_PATH}/dice/advantage.svg`,\n        normal: `${ASSET_PATH}/dice/d20.svg`,\n        disadvantage: `${ASSET_PATH}/dice/disadvantage.svg`\n    };\n\n    // 2. Gather Data from CONFIG\n    const abilities = CONFIG.DND5E.abilities;\n\n    // 3. Build Category Data (Icon-based Buttons)\n    const modeBtnHtml = Object.entries(MODE_ICONS).map(([mode, icon]) => {\n        const label = mode === \"save\" ? \"Saving Throw\" : \"Ability Check\";\n        return `<button type=\"button\" class=\"mode-btn ${mode === 'save' ? 'active' : ''}\" data-mode=\"${mode}\" title=\"${label}\">\n            <img src=\"${icon}\" />\n        </button>`;\n    }).join(\"\");\n\n    const advBtnHtml = Object.entries(ADV_ICONS).map(([mode, icon]) => {\n        const label = mode.charAt(0).toUpperCase() + mode.slice(1);\n        return `<button type=\"button\" class=\"adv-btn ${mode === 'normal' ? 'active' : ''}\" data-adv=\"${mode}\" title=\"${label}\">\n            <img src=\"${icon}\" />\n        </button>`;\n    }).join(\"\");\n\n    const abilityBtns = Object.entries(abilities).map(([id, data]) => {\n        const icon = ABILITY_ICONS[id] || DEFAULT_ICON;\n        return `<button type=\"button\" class=\"id-btn\" data-id=\"${id}\" title=\"${data.label}\">\n            <img src=\"${icon}\" />\n        </button>`;\n    }).join(\"\");\n\n    // 4. Gather Potential Actors (Player-owned)\n    const actors = game.actors.filter(a => a.hasPlayerOwner);\n    const targetedUuids = Array.from(game.user.targets).map(t => t.actor?.uuid);\n\n    const actorPortraits = actors.map(a => {\n        const imgSrc = a.prototypeToken?.texture?.src || a.img;\n        const isSelected = targetedUuids.includes(a.uuid);\n        return `\n            <div class=\"actor-portrait ${isSelected ? 'active' : ''}\" data-uuid=\"${a.uuid}\" title=\"${a.name}\">\n                <img src=\"${imgSrc}\" />\n            </div>\n        `;\n    }).join(\"\");\n\n    // 5. Build Dialog Content\n    const content = `\n    <style>\n        .roll-request-dialog { overflow: visible; }\n        .roll-request-dialog .section-label { font-weight: bold; display: block; margin-bottom: 8px; border-bottom: 1px solid #7a7971; padding-bottom: 2px; }\n        \n        .roll-request-dialog .btn-grid { \n            display: flex;\n            flex-wrap: wrap;\n            justify-content: center;\n            gap: 4px;\n            margin-bottom: 12px; \n            width: 230px;\n            margin-left: auto;\n            margin-right: auto;\n            padding: 0;\n        }\n        \n        .roll-request-dialog .mode-selection {\n            display: flex; /* Centered flex like Skill macro */\n            justify-content: center;\n            gap: 4px; /* Reduced from grid gap */\n            width: 100%;\n            margin-bottom: 12px; /* The requested vertical space */\n        }\n\n        .roll-request-dialog .mode-divider {\n            width: 1px;\n            height: 64px; /* Match button height */\n            background: #7a7971;\n            margin: 0 10px; /* Add horizontal spacing around divider */\n        }\n\n        .roll-request-dialog button {\n            padding: 2px;\n            cursor: pointer;\n            border: 1px solid #7a7971;\n            background: rgba(0,0,0,0.1);\n            width: 64px;\n            height: 64px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n        }\n        .roll-request-dialog button img {\n            width: 100%;\n            height: 100%;\n            object-fit: contain;\n            opacity: 1.0 !important;\n        }\n        .roll-request-dialog button.active {\n            border: 3px solid #ff6400 !important;\n            box-shadow: 0 0 12px #ff6400 !important;\n            background: none !important;\n        }\n        \n        .roll-request-dialog .actor-grid { \n            display: flex;\n            flex-wrap: wrap;\n            justify-content: center;\n            gap: 4px;\n            max-height: 400px; \n            overflow-y: auto; \n            margin-top: 2px;\n            width: 100%;\n            padding: 0 10px;\n            margin-left: 0;\n            margin-right: 0;\n        }\n\n        .roll-request-dialog .actor-portrait {\n            position: relative;\n            cursor: pointer;\n            border: 1px solid #7a7971;\n            width: 96px;\n            height: 96px;\n            overflow: hidden;\n            background: rgba(0,0,0,0.1);\n            transition: all 0.2s ease;\n            box-sizing: border-box;\n        }\n        .roll-request-dialog .actor-portrait img {\n            width: 100%;\n            height: 100%;\n            object-fit: cover;\n            opacity: 1.0 !important;\n        }\n        .roll-request-dialog .actor-portrait.active {\n            border: 3px solid #ff6400 !important;\n            box-shadow: 0 0 12px #ff6400 !important;\n            background: none !important;\n        }\n    </style>\n    \n    <div class=\"roll-request-dialog\">\n        <div class=\"mode-selection\">\n            ${modeBtnHtml}\n            <div class=\"mode-divider\"></div>\n            ${advBtnHtml}\n        </div>\n        <input type=\"hidden\" id=\"roll-type\" value=\"save\">\n        <input type=\"hidden\" id=\"roll-adv\" value=\"normal\">\n\n        <div id=\"selection-grid\" class=\"btn-grid\">\n            ${abilityBtns}\n        </div>\n        <input type=\"hidden\" id=\"roll-id\" value=\"\">\n\n        <div class=\"actor-grid\">\n            ${actorPortraits || \"<em>No player characters found.</em>\"}\n        </div>\n    </div>\n    `;\n\n    // 6. Render Dialog\n    new Dialog({\n        title: \"Request Save/Check\",\n        content: content,\n        buttons: {\n            request: {\n                icon: '<i class=\"fas fa-bullhorn\"></i>',\n                label: \"Request\",\n                callback: (html) => {\n                    const rollType = html.find('#roll-type').val();\n                    const advantageMode = html.find('#roll-adv').val();\n                    const id = html.find('#roll-id').val();\n                    const selectedUuids = html.find('.actor-portrait.active').map((i, el) => $(el).data('uuid')).get();\n\n                    if (!id) {\n                        ui.notifications.warn(\"No Ability selected.\");\n                        return false;\n                    }\n                    if (selectedUuids.length === 0) {\n                        ui.notifications.warn(\"No actors selected.\");\n                        return false;\n                    }\n\n                    game.socket.emit(\"module.\" + MODULE_NAME, {\n                        type: \"requestRoll\", // Main.js handles this generic type\n                        actorUuids: selectedUuids,\n                        rollType: rollType,\n                        id: id,\n                        advantageMode: advantageMode\n                    });\n\n                    ui.notifications.info(`Requested ${id.toUpperCase()} ${rollType} (${advantageMode}) from ${selectedUuids.length} actor(s).`);\n                }\n            }\n        },\n        default: \"request\",\n        render: (html) => {\n            const modeBtns = html.find('.mode-btn');\n            const advBtns = html.find('.adv-btn');\n            const selectionGrid = html.find('#selection-grid');\n            const rollTypeInput = html.find('#roll-type');\n            const rollAdvInput = html.find('#roll-adv');\n            const rollIdInput = html.find('#roll-id');\n            const actorGrid = html.find('.actor-grid');\n\n            // Handle Actor Portrait clicks\n            actorGrid.on('click', '.actor-portrait', (event) => {\n                const portrait = $(event.currentTarget);\n                portrait.toggleClass('active');\n            });\n\n            // Handle ID button clicks\n            selectionGrid.on('click', '.id-btn', (event) => {\n                const btn = $(event.currentTarget);\n                selectionGrid.find('.id-btn').removeClass('active');\n                btn.addClass('active');\n                rollIdInput.val(btn.data('id'));\n            });\n\n            // Handle Advantage Mode switching\n            advBtns.on('click', (event) => {\n                const btn = $(event.currentTarget);\n                advBtns.removeClass('active');\n                btn.addClass('active');\n                rollAdvInput.val(btn.data('adv'));\n            });\n\n            // Handle Mode switching (Save vs Check)\n            modeBtns.on('click', (event) => {\n                const btn = $(event.currentTarget);\n                const mode = btn.data('mode');\n\n                modeBtns.removeClass('active');\n                btn.addClass('active');\n                rollTypeInput.val(mode);\n\n                // Reset selection when switching modes? \n                // Usually convenient to keep \"Wisdom\" selected if switching from Save to Check.\n                // Keeping selection for now.\n            });\n        }\n    }).render(true);\n})();",
  "folder": null,
  "sort": 0,
  "ownership": {
    "default": 0
  },
  "flags": {},
  "_id": "578c2acc0e0ac593",
  "_key": "!macros!578c2acc0e0ac593",
  "_stats": {
    "systemId": "dnd5e",
    "systemVersion": "4.0.0",
    "coreVersion": "13.350",
    "createdTime": 1768663480851,
    "modifiedTime": 1768663480851,
    "lastModifiedBy": "slowglass"
  }
}